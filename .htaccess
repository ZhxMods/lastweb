# ============================================
# InfinityFree — Fixed .htaccess
# PHP 8.2 · Security-Hardened · InfinityFree Compatible
# ============================================

# Enable Rewrite Engine
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # ----------------------------------------
    # HTTPS Enforcement
    # ----------------------------------------
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # ----------------------------------------
    # Remove www (canonical URL)
    # ----------------------------------------
    RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
    RewriteRule ^ https://%1%{REQUEST_URI} [L,R=301]

    # ----------------------------------------
    # Block directory listing
    # ----------------------------------------
    Options -Indexes

    # ----------------------------------------
    # Block direct access to sensitive folders
    # ----------------------------------------
    RewriteCond %{REQUEST_URI} ^/includes/ [NC]
    RewriteRule ^(.*)$ index.php [L]

    RewriteCond %{REQUEST_URI} ^/lang/ [NC]
    RewriteRule ^(.*)$ index.php [L]

    # ----------------------------------------
    # Block access to sensitive files globally
    # ----------------------------------------
    <FilesMatch "^(config|security|database|init|functions)\.php$">
        Order Allow,Deny
        Deny from all
    </FilesMatch>

    <FilesMatch "\.(env|bak|sql|log|sh|git|gitignore|htpasswd|DS_Store)$">
        Order Allow,Deny
        Deny from all
    </FilesMatch>

    # Block .git and .env paths entirely
    RedirectMatch 404 /\.git(/|$)
    RedirectMatch 404 /\.env$
    RedirectMatch 404 .*\.(bak|sql|log|sh)$

    # ----------------------------------------
    # Skip rewriting for real files/directories
    # ----------------------------------------
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d

    # ----------------------------------------
    # Friendly URL Rules - FIXED FOR INFINITYFREE
    # ----------------------------------------

    # Admin panel pages (must come before other rules)
    RewriteRule ^admin/?$ admin/dashboard.php [L,QSA]
    RewriteRule ^admin/([a-zA-Z0-9_-]+)/?$ admin/$1.php [L,QSA]

    # Student panel pages
    RewriteRule ^student/?$ student/dashboard.php [L,QSA]
    RewriteRule ^student/([a-zA-Z0-9_-]+)/?$ student/$1.php [L,QSA]

    # AJAX endpoints
    RewriteRule ^ajax/([a-zA-Z0-9_-]+)/?$ ajax/$1.php [L,QSA]

    # Lesson, Subject, Level detail pages
    RewriteRule ^lesson/([0-9]+)/?$ lesson.php?id=$1 [L,QSA]
    RewriteRule ^subject/([0-9]+)/?$ subject.php?id=$1 [L,QSA]
    RewriteRule ^level/([0-9]+)/?$ level.php?id=$1 [L,QSA]

    # Main pages - Add .php extension
    RewriteRule ^dashboard/?$ dashboard.php [L,QSA]
    RewriteRule ^profile/?$ profile.php [L,QSA]
    RewriteRule ^login/?$ login.php [L,QSA]
    RewriteRule ^register/?$ register.php [L,QSA]
    RewriteRule ^logout/?$ logout.php [L,QSA]
    RewriteRule ^auth/?$ auth.php [L,QSA]
    RewriteRule ^set_language/?$ set_language.php [L,QSA]
    RewriteRule ^levels/?$ levels.php [L,QSA]
    RewriteRule ^subjects/?$ subjects.php [L,QSA]
    RewriteRule ^about/?$ about.php [L,QSA]
    RewriteRule ^contact/?$ contact.php [L,QSA]
    RewriteRule ^privacy/?$ privacy.php [L,QSA]
    RewriteRule ^terms/?$ terms.php [L,QSA]
    RewriteRule ^help/?$ help.php [L,QSA]
    RewriteRule ^documentation/?$ documentation.php [L,QSA]
    RewriteRule ^settings/?$ settings.php [L,QSA]

    # Catch-all for remaining pages (try adding .php)
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME}\.php -f
    RewriteRule ^([^/.]+)/?$ $1.php [L,QSA]

    # ----------------------------------------
    # Error Documents
    # ----------------------------------------
    ErrorDocument 400 /errors/400.php
    ErrorDocument 401 /errors/401.php
    ErrorDocument 403 /errors/403.php
    ErrorDocument 404 /errors/404.php
    ErrorDocument 500 /errors/500.php
    ErrorDocument 503 /errors/503.php

</IfModule>

# ============================================
# Security Headers
# ============================================
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://code.jquery.com https://cdn.jsdelivr.net https://cdn.datatables.net https://www.youtube.com https://www.youtube-nocookie.com; style-src 'self' 'unsafe-inline' https://cdn.datatables.net https://cdn.jsdelivr.net https://fonts.googleapis.com; frame-src https://www.youtube.com https://www.youtube-nocookie.com; img-src 'self' data: https:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self'; form-action 'self'; base-uri 'self';"
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# ============================================
# PHP Configuration
# ============================================
<IfModule mod_php.c>
    php_flag  display_errors         Off
    php_flag  display_startup_errors Off
    php_flag  log_errors             On
    php_value error_log              /tmp/infinityfree_errors.log
    php_value error_reporting        E_ALL
    php_flag  session.cookie_httponly On
    php_flag  session.use_strict_mode On
    php_flag  session.use_only_cookies On
    php_value session.cookie_samesite  Lax
    php_value session.gc_maxlifetime   86400
    php_value upload_max_filesize 10M
    php_value post_max_size       12M
    php_value memory_limit      128M
    php_value max_execution_time 30
    php_value max_input_time     30
    php_flag expose_php Off
</IfModule>

# ============================================
# MIME Types
# ============================================
<IfModule mod_mime.c>
    AddType application/javascript    js mjs
    AddType text/css                  css
    AddType image/svg+xml             svg svgz
    AddType application/font-woff2    woff2
    AddType application/font-woff     woff
</IfModule>

# ============================================
# GZIP Compression
# ============================================
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml image/svg+xml application/font-woff application/font-woff2
</IfModule>

# ============================================
# Browser Cache Control
# ============================================
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpeg         "access plus 1 year"
    ExpiresByType image/png          "access plus 1 year"
    ExpiresByType image/gif          "access plus 1 year"
    ExpiresByType image/webp         "access plus 1 year"
    ExpiresByType image/svg+xml      "access plus 1 year"
    ExpiresByType image/x-icon       "access plus 1 year"
    ExpiresByType font/woff2         "access plus 1 year"
    ExpiresByType font/woff          "access plus 1 year"
    ExpiresByType text/css           "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/html          "access plus 0 seconds"
</IfModule>

# ============================================
# ETag (cache validation)
# ============================================
<IfModule mod_headers.c>
    <FilesMatch "\.(js|css|jpg|jpeg|png|gif|webp|svg|woff2)$">
        Header append Cache-Control "public, immutable"
    </FilesMatch>
    <FilesMatch "\.(php|html)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>

# ============================================
# Block Bad Bots & Scanners
# ============================================
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_USER_AGENT} (nikto|sqlmap|nmap|masscan|zmeu|dirbuster|w3af|havij|openvas) [NC]
    RewriteRule .* - [F,L]
</IfModule>
