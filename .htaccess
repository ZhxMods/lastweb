# ============================================
# InfinityFree Core .htaccess Configuration
# PHP 8.2 Optimized | Security Hardened
# ============================================

# Enable Rewrite Engine
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # ============================================
    # HTTPS Enforcement
    # ============================================
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # ============================================
    # Security Headers
    # ============================================
    # Prevent directory browsing
    Options -Indexes
    
    # Protect sensitive files
    <FilesMatch "^(config|security|database)\.php$">
        Order Allow,Deny
        Deny from all
    </FilesMatch>
    
    # Block access to .git, .env, and backup files
    RedirectMatch 404 /\.git
    RedirectMatch 404 /\.env
    RedirectMatch 404 .*\.(bak|sql|log|sh)$

    # ============================================
    # Friendly URL Rewriting Rules
    # ============================================
    
    # Skip rewriting for existing files and directories
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    
    # Lesson detail: /lesson/123 -> lesson.php?id=123
    RewriteRule ^lesson/([0-9]+)/?$ lesson.php?id=$1 [L,QSA]
    
    # Subject detail: /subject/456 -> subject.php?id=456
    RewriteRule ^subject/([0-9]+)/?$ subject.php?id=$1 [L,QSA]
    
    # Level detail: /level/789 -> level.php?id=789
    RewriteRule ^level/([0-9]+)/?$ level.php?id=$1 [L,QSA]
    
    # Dashboard: /dashboard -> dashboard.php
    RewriteRule ^dashboard/?$ dashboard.php [L,QSA]
    
    # Profile: /profile -> profile.php
    RewriteRule ^profile/?$ profile.php [L,QSA]
    
    # Login: /login -> login.php
    RewriteRule ^login/?$ login.php [L,QSA]
    
    # Register: /register -> register.php
    RewriteRule ^register/?$ register.php [L,QSA]
    
    # Logout: /logout -> logout.php
    RewriteRule ^logout/?$ logout.php [L,QSA]
    
    # Admin panel: /admin/users -> admin/users.php
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^admin/([a-zA-Z0-9_-]+)/?$ admin/$1.php [L,QSA]
    
    # Student panel: /student/progress -> student/progress.php
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^student/([a-zA-Z0-9_-]+)/?$ student/$1.php [L,QSA]
    
    # Hide .php extensions for all other pages
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME}\.php -f
    RewriteRule ^([^/]+)/?$ $1.php [L,QSA]

    # ============================================
    # Error Handling
    # ============================================
    ErrorDocument 404 /404.php
    ErrorDocument 403 /403.php
    ErrorDocument 500 /500.php
</IfModule>

# ============================================
# PHP Configuration (if allowed by host)
# ============================================
<IfModule mod_php.c>
    # Security settings
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log /tmp/php_errors.log
    
    # Session security
    php_flag session.cookie_httponly On
    php_flag session.use_strict_mode On
    php_value session.cookie_samesite Lax
    
    # File upload limits
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
    
    # Memory and execution
    php_value memory_limit 128M
    php_value max_execution_time 30
</IfModule>

# ============================================
# MIME Types & Compression
# ============================================
<IfModule mod_mime.c>
    AddType application/javascript js
    AddType text/css css
</IfModule>

# Enable GZIP compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# ============================================
# Cache Control
# ============================================
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
</IfModule>
