# ============================================
# InfinityFree — Production .htaccess
# PHP 8.2 · Security-Hardened · InfinityFree
# ============================================

# Enable Rewrite Engine
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # ----------------------------------------
    # HTTPS Enforcement
    # ----------------------------------------
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # ----------------------------------------
    # Remove www (canonical URL)
    # ----------------------------------------
    RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
    RewriteRule ^ https://%1%{REQUEST_URI} [L,R=301]

    # ----------------------------------------
    # Block directory listing
    # ----------------------------------------
    Options -Indexes

    # ----------------------------------------
    # Block direct access to sensitive folders
    # ----------------------------------------
    RewriteCond %{REQUEST_URI} ^/includes/ [NC]
    RewriteRule ^(.*)$ /403.php [L,F]

    RewriteCond %{REQUEST_URI} ^/lang/ [NC]
    RewriteRule ^(.*)$ /403.php [L,F]

    RewriteCond %{REQUEST_URI} ^/admin/admin_auth\.php$ [NC]
    RewriteRule ^(.*)$ /403.php [L,F]

    # ----------------------------------------
    # Block access to sensitive files globally
    # ----------------------------------------
    <FilesMatch "^(config|security|database|init|functions)\.php$">
        Order Allow,Deny
        Deny from all
    </FilesMatch>

    <FilesMatch "\.(env|bak|sql|log|sh|git|gitignore|htpasswd|DS_Store)$">
        Order Allow,Deny
        Deny from all
    </FilesMatch>

    # Block .git and .env paths entirely
    RedirectMatch 404 /\.git(/|$)
    RedirectMatch 404 /\.env$
    RedirectMatch 404 .*\.(bak|sql|log|sh)$

    # ----------------------------------------
    # Skip rewriting for real files/directories
    # ----------------------------------------
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d

    # ----------------------------------------
    # Friendly URL Rules
    # ----------------------------------------

    # Lesson detail: /lesson/123
    RewriteRule ^lesson/([0-9]+)/?$ lesson.php?id=$1 [L,QSA]

    # Subject detail: /subject/456
    RewriteRule ^subject/([0-9]+)/?$ subject.php?id=$1 [L,QSA]

    # Level detail: /level/789
    RewriteRule ^level/([0-9]+)/?$ level.php?id=$1 [L,QSA]

    # Dashboard
    RewriteRule ^dashboard/?$ dashboard.php [L,QSA]

    # Profile
    RewriteRule ^profile/?$ profile.php [L,QSA]

    # Login
    RewriteRule ^login/?$ login.php [L,QSA]

    # Register
    RewriteRule ^register/?$ register.php [L,QSA]

    # Logout
    RewriteRule ^logout/?$ logout.php [L,QSA]

    # Auth (POST handler)
    RewriteRule ^auth/?$ auth.php [L,QSA]

    # Language switcher
    RewriteRule ^set_language/?$ set_language.php [L,QSA]

    # Admin panel: /admin/users -> admin/users.php
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^admin/([a-zA-Z0-9_-]+)/?$ admin/$1.php [L,QSA]

    # Student panel: /student/progress -> student/progress.php
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^student/([a-zA-Z0-9_-]+)/?$ student/$1.php [L,QSA]

    # AJAX endpoints: /ajax/complete_lesson -> ajax/complete_lesson.php
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ajax/([a-zA-Z0-9_-]+)/?$ ajax/$1.php [L,QSA]

    # Hide .php extensions for remaining public pages
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME}\.php -f
    RewriteRule ^([^/.]+)/?$ $1.php [L,QSA]

    # ----------------------------------------
    # Error Documents (Blue/White branded)
    # ----------------------------------------
    ErrorDocument 400 /errors/400.php
    ErrorDocument 401 /errors/401.php
    ErrorDocument 403 /errors/403.php
    ErrorDocument 404 /errors/404.php
    ErrorDocument 500 /errors/500.php
    ErrorDocument 503 /errors/503.php

</IfModule>

# ============================================
# Security Headers
# ============================================
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"

    # Prevent MIME sniffing
    Header always set X-Content-Type-Options "nosniff"

    # XSS Protection (legacy browsers)
    Header always set X-XSS-Protection "1; mode=block"

    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Content Security Policy
    # Adjust src lists as you add third-party services
    Header always set Content-Security-Policy "\
        default-src 'self'; \
        script-src 'self' 'unsafe-inline' https://code.jquery.com https://cdn.jsdelivr.net https://cdn.datatables.net https://www.youtube.com https://www.youtube-nocookie.com; \
        style-src 'self' 'unsafe-inline' https://cdn.datatables.net https://cdn.jsdelivr.net; \
        frame-src https://www.youtube.com https://www.youtube-nocookie.com; \
        img-src 'self' data: https:; \
        font-src 'self' data:; \
        connect-src 'self'; \
        form-action 'self'; \
        base-uri 'self';"

    # HSTS (enable only after you're certain HTTPS works)
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Permissions Policy (disable unneeded browser features)
    Header always set Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()"

    # Remove server signature
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# ============================================
# PHP Configuration
# ============================================
<IfModule mod_php.c>
    # ---- PRODUCTION SECURITY ----
    php_flag  display_errors         Off
    php_flag  display_startup_errors Off
    php_flag  log_errors             On
    php_value error_log              /tmp/infinityfree_errors.log
    php_value error_reporting        E_ALL

    # ---- Session Security ----
    php_flag  session.cookie_httponly On
    php_flag  session.use_strict_mode On
    php_flag  session.use_only_cookies On
    php_value session.cookie_samesite  Lax
    php_value session.gc_maxlifetime   86400

    # ---- Upload Limits ----
    php_value upload_max_filesize 10M
    php_value post_max_size       12M

    # ---- Performance ----
    php_value memory_limit      128M
    php_value max_execution_time 30
    php_value max_input_time     30

    # ---- Security Hardening ----
    php_flag expose_php Off
</IfModule>

# ============================================
# MIME Types
# ============================================
<IfModule mod_mime.c>
    AddType application/javascript    js mjs
    AddType text/css                  css
    AddType image/svg+xml             svg svgz
    AddType application/font-woff2    woff2
    AddType application/font-woff     woff
</IfModule>

# ============================================
# GZIP Compression
# ============================================
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE \
        text/html text/plain text/xml text/css text/javascript \
        application/javascript application/json application/xml \
        image/svg+xml application/font-woff application/font-woff2
</IfModule>

# ============================================
# Browser Cache Control
# ============================================
<IfModule mod_expires.c>
    ExpiresActive On

    # Images (long cache)
    ExpiresByType image/jpeg         "access plus 1 year"
    ExpiresByType image/png          "access plus 1 year"
    ExpiresByType image/gif          "access plus 1 year"
    ExpiresByType image/webp         "access plus 1 year"
    ExpiresByType image/svg+xml      "access plus 1 year"
    ExpiresByType image/x-icon       "access plus 1 year"

    # Fonts
    ExpiresByType font/woff2         "access plus 1 year"
    ExpiresByType font/woff          "access plus 1 year"

    # CSS & JS (versioned via ?v= in app, so 1 month is safe)
    ExpiresByType text/css           "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"

    # HTML — no cache for PHP pages
    ExpiresByType text/html          "access plus 0 seconds"
</IfModule>

# ============================================
# ETag (cache validation)
# ============================================
<IfModule mod_headers.c>
    <FilesMatch "\.(js|css|jpg|jpeg|png|gif|webp|svg|woff2)$">
        Header append Cache-Control "public, immutable"
    </FilesMatch>
    <FilesMatch "\.(php|html)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>

# ============================================
# Block Bad Bots & Scanners
# ============================================
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_USER_AGENT} (nikto|sqlmap|nmap|masscan|zmeu|dirbuster|w3af|havij|openvas) [NC]
    RewriteRule .* - [F,L]
</IfModule>
